#!./lua

local ui = require("ui")

local shell = require("user.shell")

ui.init()
shell.init(ui)

local history = ui.vbox({ name = "history", spacing = 4, fill = 0x000000 }, {})

local columns = ui.in_root(
   ui.hbox({ spacing = 4 }, { history })
)

local cell = 0

local function eval(self, text)
   if text:match("^$ ") then
      return shell.eval(self, text:sub(2))
   else
      cell = cell + 1
      self.text = "A" .. cell .. " = " .. self.text
      self:resize()
      self.data.add_prompt("")
   end
end

local function on_key(self, key)
   if self.text:match("^$ ") then
      return shell.on_key(self, key)
   end
end

local function add_prompt(text, dir)
   local prompt = ui.text(text, {
      cursor = #text,
      editable = true,
      eval = eval,
      on_key = on_key,
      data = {
         add_prompt = add_prompt,
      },
   })
   local window = ui.vbox({ name = "window", scrollable = false, min_w = 492, spacing = 4, fill = 0x333333, border = 0x00ffff }, {
      prompt
   })
   ui.set_focus(prompt)
   if dir == "right" then
      history = ui.vbox({ name = "history", spacing = 4, fill = 0x000000 }, {})
      columns:add_child(history)
   end
   history:add_child(window)
end

add_prompt("")

local fullscreen = false

ui.on_key(function(key, is_text, is_repeat)
   --print(key)
   if key == "Escape" then
      ui.quit()
   elseif key == "Tab" then
      add_prompt("", "right")
   elseif key == "Ctrl F" and not is_repeat then
      fullscreen = not fullscreen
      ui.fullscreen(fullscreen)
   end
end)

ui.on_mouse_drag(function(x, y)
end)

ui.run(function()
   shell.frame()
end)
